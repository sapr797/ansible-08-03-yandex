---
- name: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  hosts: remote_servers
  gather_facts: yes
  
  tasks:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      ping:

    - name: –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏—Å—Ç–µ–º–µ
      setup:
        gather_subset: min

    - name: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ
      debug:
        msg: |
          === {{ ansible_hostname }} ===
          IP: {{ ansible_default_ipv4.address }}
          –û–°: {{ ansible_distribution }} {{ ansible_distribution_version }}
          –Ø–¥—Ä–æ: {{ ansible_kernel }}
          –ü–∞–º—è—Ç—å: {{ ansible_memtotal_mb }} MB
          CPU: {{ ansible_processor_vcpus }} —è–¥–µ—Ä

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
  hosts: clickhouse
  
  tasks:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ ClickHouse
      shell: clickhouse-client --version
      register: ch_version
      changed_when: false

    - name: –í—ã–≤–æ–¥ –≤–µ—Ä—Å–∏–∏ ClickHouse
      debug:
        msg: "‚úÖ ClickHouse –≤–µ—Ä—Å–∏—è: {{ ch_version.stdout }}"

    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É–∂–±—ã ClickHouse
      systemd:
        name: clickhouse-server
      register: ch_service

    - name: –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ ClickHouse
      debug:
        msg: "–°–ª—É–∂–±–∞ ClickHouse: {{ ch_service.status.ActiveState }}"

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Vector
  hosts: vector
  
  tasks:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Vector
      shell: vector --version
      register: vector_version
      changed_when: false

    - name: –í—ã–≤–æ–¥ –≤–µ—Ä—Å–∏–∏ Vector
      debug:
        msg: "‚úÖ Vector –≤–µ—Ä—Å–∏—è: {{ vector_version.stdout }}"

    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É–∂–±—ã Vector
      systemd:
        name: vector
      register: vector_service

    - name: –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ Vector
      debug:
        msg: "–°–ª—É–∂–±–∞ Vector: {{ vector_service.status.ActiveState }}"

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ LightHouse
  hosts: localhost
  connection: local
  
  tasks:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ LightHouse
      uri:
        url: http://localhost:8080/
        method: GET
        status_code: 200
      register: lighthouse_check

    - name: –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ LightHouse
      debug:
        msg: "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π LightHouse –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8080/"

- name: –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
  hosts: localhost
  connection: local
  
  tasks:
    - name: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
      debug:
        msg: |
          üéâ –ü–†–û–ï–ö–¢ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!
          
          üìä –†–ê–ó–í–ï–†–ù–£–¢–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê:
          
          ‚úÖ –ö–û–ú–ü–û–ù–ï–ù–¢ 1: ClickHouse
          - –ê–¥—Ä–µ—Å: 178.154.223.167
          - –í–µ—Ä—Å–∏—è: 25.11.2.24
          - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
          - –ü—Ä–æ–≤–µ—Ä–∫–∞: ssh -i ~/.ssh/yandex_cloud_key ubuntu@178.154.223.167 "clickhouse-client --version"
          
          ‚úÖ –ö–û–ú–ü–û–ù–ï–ù–¢ 2: Vector
          - –ê–¥—Ä–µ—Å: 158.160.105.63
          - –í–µ—Ä—Å–∏—è: 0.35.0
          - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–±–æ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–æ–≤
          - –ü—Ä–æ–≤–µ—Ä–∫–∞: ssh -i ~/.ssh/yandex_cloud_key ubuntu@158.160.105.63 "vector --version"
          
          ‚úÖ –ö–û–ú–ü–û–ù–ï–ù–¢ 3: LightHouse
          - –ê–¥—Ä–µ—Å: http://localhost:8080/
          - –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø: http://178.154.205.62:8080/
          - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
          - –ü—Ä–æ–≤–µ—Ä–∫–∞: curl http://localhost:8080/
          
          üõ†Ô∏è –£–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ï–†–ï–ó ANSIBLE:
          - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤: ansible -i inventory_final.ini remote_servers -m ping
          - –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ansible-playbook playbooks/final-infrastructure-check.yml
          
          üìà –ì–û–¢–û–í–ù–û–°–¢–¨: 100%
          
          üöÄ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!
